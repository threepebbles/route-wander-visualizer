name: Setup Opened PRs

on:
  pull_request:
    types: [ opened, reopened ]

jobs:
  setup_pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write

    steps:
      - name: Set assignees
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { pull_request: pr, repository } = context.payload;
            const author = pr.user.login;

            await github.rest.issues.addAssignees({
              owner: repository.owner.login,
              repo: repository.name,
              issue_number: pr.number,
              assignees: [author],
            });

      - name: Set reviewers
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { pull_request: pr, repository } = context.payload;
            const author = pr.user.login;

            const feTeam = [];
            const beTeam = ['threepebbles', 'RaZel713'];

            const isAuthorFE = feTeam.includes(author);
            const isAuthorBE = beTeam.includes(author);
            const reviewers = (isAuthorFE ? feTeam : isAuthorBE ? beTeam : []).filter(r => r !== author);

            if (reviewers.length) {
              await github.rest.pulls.requestReviewers({
                owner: repository.owner.login,
                repo: repository.name,
                pull_number: pr.number,
                reviewers,
              });
            }

      - name: Set Labels
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { pull_request: pr, repository } = context.payload;

            const labels = [];
            // 1. PR ì œëª© prefix ê¸°ë°˜ ë ˆì´ë¸” ì¶”ê°€
            const title = pr.title.toLowerCase();
            const titleLabelMap = {
                'feat': 'ðŸ“ feat',
                'refactor': 'ðŸ–Œï¸ refactor',
                'test': 'âœ… test',
                'fix': 'âš’ï¸ fix',
                'chore': 'ðŸ§¹ chore',
                'docs': 'ðŸ“ docs'
            };
            const titlePrefix = Object.keys(titleLabelMap).find(prefix => title.startsWith(prefix + ':'));
            if (titlePrefix) labels.push(titleLabelMap[titlePrefix]);
            
            // 2. author ê¸°ë°˜ íŒŒíŠ¸ ë ˆì´ë¸” ì¶”ê°€
            const feTeam = [];
            const beTeam = ['threepebbles', 'RaZel713'];
            
            const author = pr.user.login;
            const partLabel = feTeam.includes(author) ? 'ðŸ–¥ï¸ Frontend' 
            : beTeam.includes(author) ? 'âš™ï¸ Backend' : null;
            if (partLabel) labels.push(partLabel);

            // 3. autherì— ë”°ë¥¸ ë‹‰ë„¤ìž„ ë¼ë²¨ ë§¤í•‘
            const personalLabelMap = {
              threepebbles: 'ðŸ í—¤ì¼ëŸ¬',
              RaZel713: 'ðŸ‹ ë¼ì ¤',
            };
            const personalLabel = personalLabelMap[author];
            if (personalLabel) labels.push(personalLabel);

            // ì¤‘ë³µ ì œê±°
            const uniqueLabels = [...new Set(labels)];

            if (uniqueLabels.length) {
              await github.rest.issues.addLabels({
                owner: repository.owner.login,
                repo: repository.name,
                pull_number: pr.number,
                labels: uniqueLabels,
              });
            }

      - name: Set Projects
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_V2_TOKEN }}
          script: |
            // Project v2 ID
            const projectId = 'PVT_kwHOAaxoFs4A9lXt';
            const { pull_request: pr } = context.payload;
            
            const fieldData = await github.graphql(
              `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 100) {
                      nodes {
                        __typename
            
                        ... on ProjectV2FieldCommon {
                          id
                          name
                        }
            
                        ... on ProjectV2SingleSelectField {
                          options {
                            id
                            name
                          }
                        }
            
                        ... on ProjectV2IterationField {
                          configuration {
                            __typename
                            ... on ProjectV2IterationFieldConfiguration {
                              iterations {
                                id
                                startDate
                                duration
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
              `,
              { projectId }
            );
            const fields = fieldData.node.fields.nodes;
            
            // 1. PRì„ Projectì— ì¶”ê°€ (ì´ë¯¸ ìžˆìœ¼ë©´ ê¸°ì¡´ item idë¥¼ ë°˜í™˜)
            const addItemResponse = await github.graphql(
              `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }
              `, 
              { projectId, contentId: pr.node_id }
            );
            const prItemId = addItemResponse.addProjectV2ItemById.item.id;

            // 2. Status í•„ë“œë¥¼ Todoë¡œ ì„¤ì •
            const statusField = fields.find(f =>
              f.__typename === 'ProjectV2SingleSelectField' &&
              f.name?.toLowerCase() === 'status'
            );
            const statusFieldId = statusField?.id;
            const todoOptionId = statusField?.options?.find(o => o.name.toLowerCase() === 'todo')?.id;
            
            if (statusFieldId && todoOptionId) {
              await github.graphql(
                `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
                `, 
                { projectId: projectId, itemId: prItemId, fieldId: statusFieldId, optionId: todoOptionId }
              );
            }

            // 3. Start Dateì„ todayë¡œ ì„¤ì •
            const openedAt = new Date(context.payload.action === 'reopened'
              ? pr.updated_at 
              : pr.created_at);
            const startDate = openedAt.toISOString().split('T')[0];

            const startDateField = fields.find(f =>
              f.__typename === 'ProjectV2Field' &&
              f.name?.toLowerCase() === 'start date'
            );
            const startDateFieldId = startDateField?.id;

            if (startDateFieldId) {
              await github.graphql(
                `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $date: Date!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { date: $date }
                  }) { projectV2Item { id } }
                }
                `,
                { projectId, itemId: prItemId, fieldId: startDateFieldId, date: startDate }
              );
            }
            
            // 4. Sprint(iteration) ì„¤ì •
            const iterationField = fields.find(f =>
              f.__typename === 'ProjectV2IterationField' &&
              f.configuration?.__typename === 'ProjectV2IterationFieldConfiguration'
            );
            const iterationFieldId = iterationField?.id;
            const iterations = iterationField?.configuration?.iterations ?? [];

            // ì˜¤ëŠ˜ì´ í¬í•¨ëœ iteration ì°¾ê¸°
            function isDateInRange(startISOString, durationDays, today) {
              const s = new Date(startISOString);
              const e = new Date(s);
              e.setDate(e.getDate() + durationDays);
              return today >= s && today < e;
            }

            const matchingIteration = iterations.find(i => isDateInRange(i.startDate, i.duration, openedAt));

            if (iterationFieldId && matchingIteration?.id) {
              await github.graphql(
                `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $iterationId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { iterationId: $iterationId }
                  }) { projectV2Item { id } }
                }
                `,
                 { projectId, itemId: prItemId, fieldId: iterationFieldId, iterationId: matchingIteration.id }
                );
            }
