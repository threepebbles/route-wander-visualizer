name: Setup Opened Issues

on:
  issues:
    types: [opened, reopened]

jobs:
  setup_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Set assignees
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, repository } = context.payload;
            const author = issue.user.login;

            await github.rest.issues.addAssignees({
              owner: repository.owner.login,
              repo: repository.name,
              issue_number: issue.number,
              assignees: [author],
            });

      - name: Set labels
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, repository } = context.payload;
            const title = issue.title;

            const titleLabelMap = {
              'test': 'test',
              'feature': 'feature',
              'frontend': 'üé® frontend',
              'backend': 'üõ†Ô∏è backend',
              'fix': 'fix',
              'style': 'style',
              'chore': 'chore',
              'docs': 'docs',
              'chore': 'chore',
              'refactor': 'refactor'
            };

            const feTeam = ['ohgus', 'AHHYUNJU', 'aydenote', 'jeongyou'];
            const beTeam = ['threepebbles', 'goohong', 'cookie-meringue', 'DongchannN'];

            const prefix = Object.keys(titleLabelMap).find(p => title.startsWith(p));
            const author = issue.user.login;
            const authorLabel = feTeam.includes(author) ? 'fe' : beTeam.includes(author) ? 'be' : null;

            const labels = [];
            if (prefix) labels.push(titleLabelMap[prefix]);
            if (authorLabel) labels.push(authorLabel);

            if (labels.length) {
              await github.rest.issues.addLabels({
                owner: repository.owner.login,
                repo: repository.name,
                issue_number: issue.number,
                labels,
              });
            }
            - name: Set Project v2
                continue-on-error: true
                uses: actions/github-script@v7
                with:
                  github-token: ${{ secrets.PROJECT_V2_TOKEN }}
                  script: |
                    const { issue } = context.payload;
                    const projectNodeId = 'PVT_kwDOA_44FM4A9RQT';
                    const addItemResponse = await github.graphql(`
                      mutation($projectId: ID!, $contentId: ID!) {
                        addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                          item { id }
                        }
                      }
                    `, {
                      projectId: projectNodeId,
                      contentId: issue.node_id,
                    });
                    
                    const itemId = addItemResponse.addProjectV2ItemById.item.id;
                    
                    const statusFieldId = 'PVTSSF_lADOA_44FM4A9RQTzgxBWgo';
                    const todoOptionId = 'f75ad846';
                    
                    await github.graphql(`
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId,
                          itemId: $itemId,
                          fieldId: $fieldId,
                          value: { singleSelectOptionId: $optionId }
                        }) {
                          projectV2Item { id }
                        }
                      }
                    `, {
                      projectId: projectNodeId,
                      itemId,
                      fieldId: statusFieldId,
                      optionId: todoOptionId,
                    });

      - name: Set Project v2
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_V2_TOKEN }}
          script: |
            // GitHub ActionsÏóêÏÑú Ï†ÑÎã¨ Î∞õÏùÄ Issue Ï†ïÎ≥¥
            const { issue } = context.payload;
            
            // GitHub Project v2Ïùò Í≥†Ïú† Node ID (GraphQL Ï†ÑÏö©)
            const projectNodeId = 'PVT_kwDOA_44FM4A9rer';
            
            // IssueÎ•º Project ÏïÑÏù¥ÌÖúÏúºÎ°ú Ï∂îÍ∞Ä
            const addItemResponse = await github.graphql(`
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }
            `, {
              projectId: projectNodeId,
              contentId: issue.node_id,
            });
            
            // ÏÉùÏÑ±Îêú Project ÏïÑÏù¥ÌÖúÏùò id
            const itemId = addItemResponse.addProjectV2ItemById.item.id;
            
            // ProjectÏùò "Status" ÌïÑÎìúÏôÄ "TODO" ÏòµÏÖòÏùò Í≥†Ïú† ID
            const statusFieldId = 'PVTSSF_lADOA_44FM4A97bwzgxfBsA';
            const todoOptionId = 'f75ad846';
            
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId: projectNodeId,
              itemId,
              fieldId: statusFieldId,
              optionId: todoOptionId,
            });
